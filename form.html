<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checklist Facility Management - IA Séquentiel</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #1a2a44 0%, #0d1b2a 100%);
      padding: 2rem;
      max-width: 700px;
      margin: auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #ecf0f1;
    }
    h1 {
      color: #ecf0f1;
      font-size: 2rem;
      text-align: center;
      margin-bottom: 1.5rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .point-container {
      background: #f0f2f5;
      border: 2px solid #1a2a44;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      width: 100%;
      transition: transform 0.3s ease;
      color: #2c3e50;
    }
    .point-container:hover {
      transform: translateY(-5px);
    }
    .point-container p {
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    input[type="text"], input[type="file"] {
      width: 100%;
      padding: 0.8rem;
      margin: 0.5rem 0;
      border: 1px solid #1a2a44;
      border-radius: 8px;
      font-size: 1rem;
      background: #ffffff;
      color: #2c3e50;
    }
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .buttons button {
      padding: 0.8rem 1.2rem;
      border: none;
      border-radius: 8px;
      background: #3b5998;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s, font-weight 0.2s;
    }
    .buttons button:hover {
      background: #2e4373;
      transform: scale(1.05);
    }
    .buttons button.selected {
      background: #4a69bd;
      font-weight: bold;
      transform: scale(1.1);
    }
    #photo-preview {
      max-width: 100%;
      margin-top: 0.5rem;
      border-radius: 8px;
      display: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    #photo-preview:hover {
      transform: scale(1.02);
    }
    #ai-suggestion {
      margin: 1rem 0;
      font-style: italic;
      color: #34495e;
      background: #ffffff;
      padding: 0.8rem;
      border-radius: 8px;
      border-left: 4px solid #3b5998;
    }
    .action-button {
      padding: 0.8rem 2rem;
      border: none;
      border-radius: 8px;
      background: #34495e;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
      margin-top: 1rem;
    }
    .action-button:hover {
      background: #2c3e50;
      transform: scale(1.05);
    }
    .action-button.loading::after {
      content: ' ⏳';
      animation: spin 1s linear infinite;
    }
    #result {
      font-weight: bold;
      font-size: 1.2rem;
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
    #result.success {
      background: #2ecc71;
      color: white;
    }
    #result.error {
      background: #e74c3c;
      color: white;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 600px) {
      body { padding: 1rem; }
      h1 { font-size: 1.5rem; }
      .point-container { padding: 1rem; }
      .buttons button, .action-button { font-size: 0.9rem; padding: 0.6rem 1rem; }
    }
  </style>
</head>
<body>
  <h1>Checklist Facility Management</h1>
  <div id="form-area"></div>
  <p id="result"></p>

  <script>
    // ⚠️ Remplacer par une variable d’environnement en prod
    const OPENAI_API_KEY = OPENAIAPIKEYVERCEL
    const WEBHOOK_URL = 'https://maxencegauthier.app.n8n.cloud/webhook/facilitymanagementchecklist';

    const pointLabels = [
      "Fassade: Material und Zustand", "Dach: Sichtbare Schäden", "Fenster & Türen (Außen): Material und Zustand",
      "Parkplätze und Zufahrten", "Anlieferungsbereiche", "Allgemeine Sauberkeit und Pflegezustand",
      "Beleuchtung Außenbereich", "Werbepylon/Schilder", "Bodenbeläge: Art und Zustand",
      "Wände: Oberflächen und Zustand", "Decken: Oberflächen und Zustand", "Beleuchtung: Art, Helligkeit, Funktion",
      "Heizung, Lüftung, Klima (HLK): Zustand et Funktionnalité", "Sanitäranlagen: Anzahl et Zustand", "Elektrik: Zustand de l'installation",
      "Türen (Innen): Art, Zustand, Funktion", "Aufzüge/Rolltreppen (falls vorhanden)", "Sicherheitssysteme (Brand, Einbruch)",
      "Internet-/Téléphone Anschluss", "Lager- und Sozialräume", "Energieeffizienz: Dämmung, moderne HLK, PV",
      "Wassereffizienz: Sanitärinstallationen, Regenwassernutzung", "Abfallmanagement: Trennsysteme", "Barrierefreiheit",
      "Mieter-Engagement: Nachhaltigkeit"
    ];

    let currentIndex = 0;
    const formData = {};
    let currentFile = null;
    let selectedRating = null;
    let aiSuggestion = '';

    function showPoint() {
      const container = document.getElementById('form-area');
      container.innerHTML = '';
      if (currentIndex === 0) {
        container.innerHTML = `
          <div class="point-container">
            <p><strong>Asset ID</strong></p>
            <input type="text" id="assetInput" placeholder="ex: A1, B2..." />
            <button class="action-button" onclick="nextFromAsset()">Suivant ➔</button>
          </div>`;
        return;
      }
      const idx = currentIndex - 1;
      if (idx < pointLabels.length) {
        container.innerHTML = `
          <div class="point-container">
            <p><strong>Point ${currentIndex}/${pointLabels.length}: ${pointLabels[idx]}</strong></p>
            <div class="buttons">${['1', '2', '3', '4', '5', 'N/A']
              .map(v => `<button class="${selectedRating === v ? 'selected' : ''}" onclick="selectRating('${v}')">${v}</button>`).join(' ')}</div>
            <div>
              Photo (optionnel, pour IA): <input type="file" id="photoInput" accept="image/*" />
              <img id="photo-preview" src="${currentFile ? URL.createObjectURL(currentFile) : ''}" alt="Preview" ${currentFile ? 'style="display: block;"' : 'style="display: none;"'} />
            </div>
            <button class="action-button" onclick="getAdvice()">Conseil IA</button>
            <p id="ai-suggestion">${aiSuggestion || 'Conseil IA: En attente...'}</p>
            <button class="action-button" onclick="nextPoint()">Suivant ➔</button>
          </div>`;
        document.getElementById('photoInput').addEventListener('change', e => handleFile(e.target.files[0]));
      } else {
        submitAll();
      }
    }

    function nextFromAsset() {
      const val = document.getElementById('assetInput').value.trim();
      if (!val) return alert("Merci d'entrer un Asset ID");
      formData.asset_id = val;
      formData.date = new Date().toISOString().split('T')[0];
      currentIndex++;
      selectedRating = null;
      currentFile = null;
      aiSuggestion = '';
      showPoint();
    }

    function selectRating(val) {
      selectedRating = val;
      formData[`point_${currentIndex}`] = val;
      // Mettre à jour les boutons immédiatement
      const buttons = document.querySelectorAll('.buttons button');
      buttons.forEach(btn => btn.classList.remove('selected'));
      buttons.forEach(btn => {
        if (btn.textContent.trim() === val) {
          btn.classList.add('selected');
        }
      });
    }

    function nextPoint() {
      if (!formData[`point_${currentIndex}`]) {
        alert("Veuillez sélectionner une note avant de passer au point suivant.");
        return;
      }
      currentIndex++;
      selectedRating = null;
      currentFile = null;
      aiSuggestion = '';
      showPoint();
    }

    function handleFile(file) {
      currentFile = file;
      const reader = new FileReader();
      reader.onload = () => {
        const img = document.getElementById('photo-preview');
        img.src = reader.result;
        img.style.display = 'block';
      };
      reader.readAsDataURL(file);
      showPoint(); // Mettre à jour la prévisualisation
    }

    async function getAdvice() {
      const idx = currentIndex - 1;
      const label = pointLabels[idx];
      if (!currentFile) return alert('Veuillez uploader une photo pour obtenir un conseil IA.');

      const adviceButton = document.querySelector('.action-button[onclick="getAdvice()"]');
      adviceButton.classList.add('loading');
      adviceButton.disabled = true;

      const reader = new FileReader();
      reader.onload = async () => {
        const base64Image = reader.result.split(',')[1];
        const payload = {
          model: 'gpt-4o-mini',
          messages: [
            {
              role: 'system',
              content: 'Tu es un expert en facility management. Analyse cette image et suggère une note de 1 à 5 ou N/A uniquement pour le point spécifié (ex: "Fassade: Material und Zustand"), en fonction de l’état observé. Retourne uniquement une note (1, 2, 3, 4, 5 ou N/A) et une courte justification (max 50 mots). Format : "Note: X\nJustification: Texte".'
            },
            {
              role: 'user',
              content: [
                { type: 'text', text: `Point: ${label}. Suggère une note (1 à 5 ou N/A) basée sur cette image, en te concentrant uniquement sur ce point.` },
                { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${base64Image}` } }
              ]
            }
          ],
          max_tokens: 100
        };

        try {
          console.log('Envoi de l’image à l’API OpenAI...');
          const res = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${OPENAI_API_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`Erreur API: ${errorText}`);
          }
          const data = await res.json();
          const suggestion = data.choices[0].message.content.trim();
          console.log('Réponse IA:', suggestion);
          aiSuggestion = `Conseil IA: ${suggestion}`;
          showPoint(); // Mettre à jour la suggestion sans réinitialiser
        } catch (e) {
          console.error('Erreur lors de l’appel API:', e);
          aiSuggestion = `Erreur IA: ${e.message}`;
          showPoint();
        } finally {
          adviceButton.classList.remove('loading');
          adviceButton.disabled = false;
        }
      };
      reader.readAsDataURL(currentFile);
    }

    async function submitAll() {
      try {
        const r = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        if (!r.ok) throw new Error(await r.text());
        document.getElementById('result').innerText = '✔️ Données envoyées ! Page recharge...';
        document.getElementById('result').classList.add('success');
        setTimeout(() => location.reload(), 5000);
      } catch (e) {
        console.error('Erreur envoi webhook:', e);
        document.getElementById('result').innerText = `Erreur envoi : ${e.message}`;
        document.getElementById('result').classList.add('error');
      }
    }

    // Helper pour sélectionner un bouton par texte
    HTMLElement.prototype.contains = function(text) {
      return this.textContent.trim() === text;
    };

    showPoint();
  </script>
</body>
</html>